@model IEnumerable<Bloomfiy.Models.Product>
@{
    ViewBag.Title = "Flower Catalog - Bloomfiy";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var categories = ViewBag.Categories as List<Bloomfiy.Models.Category>;
    var colors = ViewBag.Colors as List<Bloomfiy.Models.Color>;
}

<section class="shop-hero">
    <div class="container">
        <h1>Our Flower Collection</h1>
        <p>Discover beautiful floral arrangements for every occasion</p>
    </div>
</section>

<section class="product-catalog">
    <div class="container">
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar">
            <!-- Category Filter -->
            @if (categories != null && categories.Any())
            {
                <div class="filter-group">
                    <h3>Categories</h3>
                    <div class="filter-options">
                        @foreach (var category in categories)
                        {
                            <label class="filter-option">
                                <input type="checkbox" data-category="@category.CategoryId"> @category.CategoryName
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- Color Filter -->
            @if (colors != null && colors.Any())
            {
                <div class="filter-group">
                    <h3>Colors</h3>
                    <div class="color-filters">
                        @foreach (var color in colors)
                        {
                            <div class="color-option"
                                 style="background-color: @(!string.IsNullOrEmpty(color.ColorCode) ? color.ColorCode : "#ccc")"
                                 data-color-id="@color.ColorId"
                                 title="@color.ColorName">
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Price Range -->
            <div class="filter-group">
                <h3>Price Range</h3>
                <div class="price-range">
                    <input type="range" min="0" max="200" value="200" class="price-slider" id="priceSlider">
                    <div class="price-values">
                        <span>$<span id="minPrice">0</span></span>
                        <span>$<span id="maxPrice">200</span></span>
                    </div>
                </div>
            </div>

            <button class="clear-filters-btn" id="clearFilters">Clear All Filters</button>
        </aside>

        <!-- Products Main Area -->
        <div class="products-main">
            <div class="products-header">
                <div class="results-count">
                    Showing @Model.Count() product@(Model.Count() != 1 ? "s" : "")
                </div>
                <div class="sort-options">
                    <select class="sort-select" id="sortSelect">
                        <option value="name">Sort by: Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
            </div>

            @if (Model.Any())
            {
                <div class="products-grid" id="productsGrid">
                    @foreach (var product in Model)
                    {
                        <div class="product-card" data-product-id="@product.ProductId"
                             data-price="@product.BasePrice"
                             data-category="@product.CategoryId">
                            <div class="product-image">
                                <img src="@product.MainImageUrl" alt="@product.Name" class="main-product-image">
                                <div class="product-actions">
                                    <button class="wishlist-btn" title="Add to Wishlist">♡</button>
                                    <button class="quick-view-btn" title="Quick View">👁️</button>
                                </div>
                                @if (product.BasePrice > 50)
                                {
                                    <div class="product-badge">Premium</div>
                                }
                            </div>
                            <div class="product-info">
                                <h3 class="product-title">@product.Name</h3>
                                <p class="product-description">@(product.Description.Length > 100 ? product.Description.Substring(0, 100) + "..." : product.Description)</p>

                                <div class="product-price">
                                    <span class="current-price">$@product.BasePrice</span>
                                    @if (product.BasePrice < 80)
                                    {
                                        <span class="original-price">$@(product.BasePrice + 10)</span>
                                    }
                                </div>

                                @if (product.ProductColors != null && product.ProductColors.Any())
                                {
                                    <div class="product-colors">
                                        Available in:
                                        @foreach (var pc in product.ProductColors.Take(3))
                                        {
                                            <span class="color-chip" style="background-color: @(!string.IsNullOrEmpty(pc.Color?.ColorCode) ? pc.Color.ColorCode : "#ccc")"
                                                  title="@pc.Color?.ColorName">
                                            </span>
                                        }
                                        @if (product.ProductColors.Count > 3)
                                        {
                                            <span class="more-colors">+@(product.ProductColors.Count - 3) more</span>
                                        }
                                    </div>
                                }

                                <button class="add-to-cart-btn" data-product-id="@product.ProductId">Add to Cart</button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-products">
                    <p>No products found. Please try a different filter or search.</p>
                    <a href="@Url.Action("Catalog")" class="btn btn-primary">View All Products</a>
                </div>
            }
        </div>
    </div>
</section>

@section Scripts {
    <script>
    $(document).ready(function() {
        // Product card click navigation
        $('.product-card').click(function(e) {
            if (!$(e.target).closest('button').length) {
                var productId = $(this).data('product-id');
                window.location.href = '@Url.Action("Details", "Product")/' + productId;
            }
        });

        // Filter functionality
        $('#clearFilters').click(function() {
            $('.filter-options input[type="checkbox"]').prop('checked', false);
            $('#priceSlider').val(200);
            updatePriceDisplay();
            filterProducts();
        });

        // Price slider
        $('#priceSlider').on('input', function() {
            updatePriceDisplay();
            filterProducts();
        });

        // Category/color filter
        $('.filter-options input, .color-option').change(function() {
            filterProducts();
        });

        // Sort functionality
        $('#sortSelect').change(function() {
            sortProducts($(this).val());
        });

        function updatePriceDisplay() {
            var maxPrice = $('#priceSlider').val();
            $('#maxPrice').text(maxPrice);
        }

        function filterProducts() {
            var selectedCategories = [];
            $('.filter-options input[type="checkbox"]:checked').each(function() {
                selectedCategories.push($(this).data('category'));
            });

            var selectedColors = [];
            $('.color-option.active').each(function() {
                selectedColors.push($(this).data('color-id'));
            });

            var maxPrice = $('#priceSlider').val();

            $('.product-card').each(function() {
                var $card = $(this);
                var categoryId = $card.data('category');
                var price = $card.data('price');

                var showCard = true;

                // Category filter
                if (selectedCategories.length > 0 && !selectedCategories.includes(categoryId)) {
                    showCard = false;
                }

                // Price filter
                if (price > maxPrice) {
                    showCard = false;
                }

                // Color filter (simplified - would need color IDs on product cards)
                // You would need to add data-colors attribute to product cards

                if (showCard) {
                    $card.show();
                } else {
                    $card.hide();
                }
            });
        }

        function sortProducts(sortBy) {
            var $container = $('#productsGrid');
            var $items = $container.children('.product-card');

            $items.sort(function(a, b) {
                var aPrice = $(a).data('price');
                var bPrice = $(b).data('price');
                var aName = $(a).find('.product-title').text().toLowerCase();
                var bName = $(b).find('.product-title').text().toLowerCase();

                switch(sortBy) {
                    case 'price-low':
                        return aPrice - bPrice;
                    case 'price-high':
                        return bPrice - aPrice;
                    case 'newest':
                        // Assuming newer products have higher IDs
                        return $(b).data('product-id') - $(a).data('product-id');
                    default: // 'name'
                        return aName.localeCompare(bName);
                }
            });

            $container.append($items);
        }
    });
    </script>
}